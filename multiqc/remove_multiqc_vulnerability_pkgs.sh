#!/bin/bash
# Wrapper to remove vulnerable Python packages

PROJECT_DIR=${PROJECT_DIR:-/mira-nf}
PYTHON_VERSION=${python_version:-python3.10}
REMOVE_PKGS="${PROJECT_DIR}/remove_vulnerability_pkgs.txt"
REMOVE_PKGS_CLEAN="${PROJECT_DIR}/remove_vulnerability_pkgs_clean.txt"

echo "Remove packages file: $REMOVE_PKGS"

# Remove packages if the file exists
if [[ -f "$REMOVE_PKGS" ]]; then
    echo "Removing vulnerability packages..."

    # Remove blank lines from the file
    awk NF <"$REMOVE_PKGS" >"$REMOVE_PKGS_CLEAN"

    # Get number of packages
    n=$(wc -l <"$REMOVE_PKGS_CLEAN")
    i=1

    while [[ $i -le $n ]]; do
        echo "Processing package #$i"

        # Get the package name
        pkg_name=$(sed -n "${i}p" "$REMOVE_PKGS_CLEAN" | tr -d '\r')
        echo "Removing package: $pkg_name"

        # Remove package directories if they exist
        find "/usr/local/lib/${PYTHON_VERSION}/site-packages" -name "*${pkg_name}*" -exec rm -rf {} \;

        ((i++))
    done

    echo "All vulnerable packages removed."
fi
