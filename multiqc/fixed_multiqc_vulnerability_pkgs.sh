
#!/bin/bash
# Wrapper to install python packages 

# Path to requirement file
PROJECT_DIR=${PROJECT_DIR:-/multiqc}
fixed_pkgs=${PROJECT_DIR}/fixed_vulnerability_pkgs.txt
fixed_pkgs_clean=${PROJECT_DIR}/fixed_vulnerability_pkgs_clean.txt

echo $fixed_pkgs

# Install updated version of python pkgs
if [[ -f ${fixed_pkgs} ]]
then

    echo "Update python packages"

	# Remove blank lines from the file and save a cleaner version of it
	awk NF < ${fixed_pkgs} > ${fixed_pkgs_clean}

	# Get number of packages in the file
	n=`wc -l < ${fixed_pkgs_clean}`
	i=1

    while [[ i -le $n ]];
	do
		echo $i
		# Get the name of the package and its version
		updated_pkg=$(head -${i} ${fixed_pkgs_clean} | tail -1 | sed -e 's,\r,,g')
		echo $updated_pkg
        pkg_name=$(echo ${updated_pkg} | sed -e "s/\(.*\)\(==\)\(.*\)/\1/g")
		echo $pkg_name
        # Check if package already existed in pip install
        check_pip_pkg=$(pip list | grep -w ${pkg_name} | sed -e "s/\s\+/==/g")
		echo $check_pip_pkg
        # If package exists, update to new version
        case ${check_pip_pkg} in
            "") ;;
            *)  pip install --no-cache-dir ${updated_pkg};;
        esac
        # Go to next pkg
        i=$(($i+1))
    done

	# Return message to keep the process going
    echo "Done"

fi


