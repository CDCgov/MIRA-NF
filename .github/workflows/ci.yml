name: Run Pipeline Tests CI/CD
# This workflow runs the pipeline with the minimal test dataset to check that it completes without any syntax errors

on:
  workflow_call:
    inputs:
      run_tests:
        description: "Comma separated tests to run (Ex: tests/default.nf.test,tests/flu.nf.test)"
        required: false
        default: "tests/default.nf.test"
      max_parallel:
        description: "Maximum number of parallel test runs"
        required: false
        default: 2
        type: number
      nft_profile:
        description: "Nextflow profile(s) to use"
        required: false
        default: "test,docker"
      nxf_version:
        description: "Nextflow version to use"
        required: false
        default: "24.04.2"

# Ensure only one workflow run per PR/branch, cancel previous if a new one is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  pipeline-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set environment variables
        run: |
          echo "RUN_TESTS=${{ inputs.run_tests }}" >> $GITHUB_ENV
          echo "MAX_PARALLEL=${{ inputs.max_parallel }}" >> $GITHUB_ENV
          echo "NFT_PROFILE=${{ inputs.nft_profile }}" >> $GITHUB_ENV
          echo "NXF_VERSION=${{ inputs.nxf_version }}" >> $GITHUB_ENV

      - name: Run pipeline tests
        run: |
          echo "Running pipeline tests with:"
          echo "  run_tests=$RUN_TESTS"
          echo "  max_parallel=$MAX_PARALLEL"
          echo "  nft_profile=$NFT_PROFILE"
          echo "  nxf_version=$NXF_VERSION"
          # Replace the echo below with your real Nextflow test command
          # Example:
          # nextflow run main.nf -profile $NFT_PROFILE -with-trace $RUN_TESTS
          echo "Simulating pipeline test execution..."