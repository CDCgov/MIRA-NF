name: Run Pipeline Tests CI/CD

on:
  workflow_call:
    inputs:
      run_on_batch:
        description: "Run tests in batch mode"
        required: false
        default: false
        type: boolean
      only_changed:
        description: "Run tests only for changed modules"
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  pipeline-test:
    strategy:
      matrix:
        NXF_VER: ["24.10.5"]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set environment variables
        run: |
          echo "RUN_ON_BATCH=${{ inputs.run_on_batch }}" >> $GITHUB_ENV
          echo "ONLY_CHANGED=${{ inputs.only_changed }}" >> $GITHUB_ENV
          echo "NXF_VERSION=${{ matrix.NXF_VER }}" >> $GITHUB_ENV
          echo "NFT_PROFILE=$( [[ '${{ inputs.run_on_batch }}' == 'true' ]] && echo 'dev' || echo 'standard,dev_reg' )" >> $GITHUB_ENV
          echo "MAX_PARALLEL=2" >> $GITHUB_ENV  # Can be hardcoded or also added as input

      - name: Run pipeline tests
        run: |
          echo "Running nf-test with:"
          echo "  NXF_VERSION=$NXF_VERSION"
          echo "  RUN_ON_BATCH=$RUN_ON_BATCH"
          echo "  ONLY_CHANGED=$ONLY_CHANGED"
          echo "  NFT_PROFILE=$NFT_PROFILE"
          echo "  MAX_PARALLEL=$MAX_PARALLEL"
          # Replace below with your actual nf-test command:
          # nextflow run main.nf -profile $NFT_PROFILE -with-trace tests/default.nf.test
          echo "Simulating nf-test execution..."