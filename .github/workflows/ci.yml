name: Run Pipeline Tests CI/CD
# Reusable workflow for nf-test pipeline

on:
  workflow_call:
    inputs:
      run_tests:
        description: "Comma separated tests to run (Ex: tests/default.nf.test,tests/flu.nf.test)"
        required: false
        default: "tests/default.nf.test"
        type: string
      max_parallel:
        description: "Maximum number of parallel test runs"
        required: false
        default: 2
        type: number
      nft_profile:
        description: "Nextflow profile(s) to use"
        required: false
        default: "test,docker"
        type: string
      nxf_version:
        description: "Nextflow version to use"
        required: false
        default: "24.10.5"
        type: string
      only_changed:
        description: "Run tests only for changed modules"
        required: false
        default: false
        type: boolean

# Concurrency: only one workflow active per branch or PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  pipeline-test:
    strategy:
      matrix:
        NXF_VER: ["24.10.5", "24.04.2"]  # Add more versions as needed
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set environment variables
        run: |
          echo "RUN_TESTS=${{ inputs.run_tests }}" >> $GITHUB_ENV
          echo "MAX_PARALLEL=${{ inputs.max_parallel }}" >> $GITHUB_ENV
          echo "NFT_PROFILE=${{ inputs.nft_profile }}" >> $GITHUB_ENV
          echo "NXF_VERSION=${{ matrix.NXF_VER }}" >> $GITHUB_ENV
          echo "ONLY_CHANGED=${{ inputs.only_changed }}" >> $GITHUB_ENV

      - name: Run pipeline tests
        run: |
          echo "Running pipeline tests with:"
          echo "  run_tests=$RUN_TESTS"
          echo "  max_parallel=$MAX_PARALLEL"
          echo "  nft_profile=$NFT_PROFILE"
          echo "  nxf_version=$NXF_VERSION"
          echo "  only_changed=$ONLY_CHANGED"
          # Replace the echo below with your real nf-test command
          # Example:
          # nextflow run main.nf -profile $NFT_PROFILE -with-trace $RUN_TESTS
          echo "Simulating pipeline test execution..."