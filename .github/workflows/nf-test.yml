name: NF Test Reusable Workflow

on:
  workflow_call:
    inputs:
      run_on_aws:
        description: "Run pipeline on AWS"
        required: false
        type: boolean
        default: false
      component_type:
        description: "Component type"
        required: true
        type: string
      run_tests:
        description: "Comma separated test files"
        required: false
        type: string
        default: "tests/default.nf.test"
      nft_profile:
        description: "Nextflow profile"
        required: false
        type: string
        default: "gh_test,docker"
      nxf_version:
        description: "Nextflow version"
        required: false
        type: string
        default: "24.10.5"
      max_parallel:
        description: "Maximum parallel runs"
        required: false
        type: number
        default: 2

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Nextflow
        run: |
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/
          nextflow -version
        env:
          NXF_VER: ${{ inputs.nxf_version }}

      - name: Install nf-test
        run: |
          curl -fsSL https://code.askimed.com/install/nf-test | bash
          sudo mv nf-test /usr/local/bin/
          nf-test version

      - name: Extract runpaths and download locally
        run: |
          BASE_DIR="${{ github.workspace }}/test_data"
          mkdir -p "$BASE_DIR"

          CLONED_REPOS=""

          for TEST_FILE in $(echo "${{ inputs.run_tests }}" | tr ',' ' '); do
            echo "=== Processing test file: $TEST_FILE ==="

            # Extract all unique runpath URLs from this test file, one per line
            RUNPATHS=$(grep -oP 'runpath\s*=\s*"\K[^"]+' "$TEST_FILE" | sort -u)

            if [ -z "$RUNPATHS" ]; then
              echo "No runpath found in $TEST_FILE, skipping."
              continue
            fi

            while IFS= read -r RUNPATH; do
              echo "Found runpath: $RUNPATH"

              # Validate it looks like a GitHub tree URL
              if ! echo "$RUNPATH" | grep -qP '^https://github\.com/[^/]+/[^/]+/tree/'; then
                echo "WARNING: runpath does not look like a GitHub tree URL, skipping: $RUNPATH"
                continue
              fi

              REPO_URL=$(echo "$RUNPATH" | grep -oP 'https://github\.com/[^/]+/[^/]+')
              TREE_SUFFIX=$(echo "$RUNPATH" | sed 's|.*/tree/||')
              BRANCH=$(echo "$TREE_SUFFIX" | cut -d'/' -f1)
              SUBDIR=$(echo "$TREE_SUFFIX" | cut -d'/' -f2-)

              echo "Repo: $REPO_URL | Branch: $BRANCH | Subdir: $SUBDIR"

              # Use a stable local path based on the subdir name (last component)
              LOCAL_SUBDIR_NAME=$(basename "$SUBDIR")
              LOCAL_DEST="$BASE_DIR/$LOCAL_SUBDIR_NAME"
              mkdir -p "$LOCAL_DEST"

              # Only clone each repo+branch once
              CLONE_KEY="${REPO_URL}@${BRANCH}"
              if echo "$CLONED_REPOS" | grep -qF "$CLONE_KEY"; then
                echo "Already cloned $CLONE_KEY, reusing."
                CLONE_DIR=$(echo "$CLONED_REPOS" | grep -oP "(?<=${CLONE_KEY}=)[^ ]+")
              else
                CLONE_DIR=$(mktemp -d)
                git clone --depth 1 --branch "$BRANCH" "$REPO_URL" "$CLONE_DIR"
                CLONED_REPOS="$CLONED_REPOS ${CLONE_KEY}=${CLONE_DIR}"
              fi

              if [ ! -d "$CLONE_DIR/$SUBDIR" ]; then
                echo "ERROR: Subdirectory '$SUBDIR' not found in cloned repo."
                ls "$CLONE_DIR"
                exit 1
              fi

              cp -r "$CLONE_DIR/$SUBDIR/." "$LOCAL_DEST/"
              echo "Downloaded '$SUBDIR' to: $LOCAL_DEST"
              ls "$LOCAL_DEST"

              # Patch this specific runpath URL to the local destination
              echo "Patching runpath in: $TEST_FILE"
              # Escape special characters in RUNPATH for use in sed
              ESCAPED_RUNPATH=$(printf '%s\n' "$RUNPATH" | sed 's|[&/\]|\\&|g')
              ESCAPED_LOCAL=$(printf '%s\n' "$LOCAL_DEST" | sed 's|[&/\]|\\&|g')
              sed -i "s|runpath = \"${ESCAPED_RUNPATH}\"|runpath = \"${ESCAPED_LOCAL}\"|g" "$TEST_FILE"

            done <<< "$RUNPATHS"

            echo "--- Final runpath lines in $TEST_FILE ---"
            grep 'runpath' "$TEST_FILE" || echo "(no runpath lines found)"
          done

          # Clean up cloned repos
          for ENTRY in $CLONED_REPOS; do
            DIR=$(echo "$ENTRY" | cut -d'=' -f2)
            rm -rf "$DIR"
          done

      - name: Run pipeline tests
        run: |
          echo "Running tests on local runner..."
          echo "Tests: ${{ inputs.run_tests }}"
          echo "Profile: ${{ inputs.nft_profile }}"
          echo "Nextflow version: ${{ inputs.nxf_version }}"
          echo "Max parallel: ${{ inputs.max_parallel }}"

          TEST_FILES=$(echo "${{ inputs.run_tests }}" | tr ',' ' ')

          nf-test test \
            --profile "${{ inputs.nft_profile }}" \
            $TEST_FILES