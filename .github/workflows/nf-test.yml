name: NF Test Reusable Workflow

on:
  workflow_call:
    inputs:
      run_on_aws:
        description: "Run pipeline on AWS"
        required: false
        type: boolean
        default: false
      component_type:
        description: "Component type"
        required: true
        type: string
      run_tests:
        description: "Comma separated test files"
        required: false
        type: string
        default: "tests/default.nf.test"
      nft_profile:
        description: "Nextflow profile"
        required: false
        type: string
        default: "gh_test,docker"
      nxf_version:
        description: "Nextflow version"
        required: false
        type: string
        default: "24.10.5"
      max_parallel:
        description: "Maximum parallel runs"
        required: false
        type: number
        default: 2

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Nextflow
        run: |
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/
          nextflow -version
        env:
          NXF_VER: ${{ inputs.nxf_version }}

      - name: Install nf-test
        run: |
          curl -fsSL https://code.askimed.com/install/nf-test | bash
          sudo mv nf-test /usr/local/bin/
          nf-test version

      - name: Extract runpath and download locally
        run: |
          LOCAL_RUNPATH="${{ github.workspace }}/test_data"
          mkdir -p "$LOCAL_RUNPATH"

          # Use the first test file to extract the runpath
          FIRST_TEST=$(echo "${{ inputs.run_tests }}" | tr ',' ' ' | awk '{print $1}')
          RUNPATH=$(grep -o 'runpath\s*=\s*"[^"]*"' "$FIRST_TEST" | grep -o '"[^"]*"' | tr -d '"' | tr -d '_')

          if [ -z "$RUNPATH" ]; then
            echo "No runpath found in $FIRST_TEST, skipping download."
          else
            echo "Found runpath: $RUNPATH"

            REPO_URL=$(echo "$RUNPATH" | grep -oP 'https://github\.com/[^/]+/[^/]+')
            BRANCH=$(echo "$RUNPATH" | grep -oP '(?<=/tree/)[^/]+')
            SUBDIR=$(echo "$RUNPATH" | grep -oP '(?<=/tree/[^/]+/).+')

            echo "Repo: $REPO_URL | Branch: $BRANCH | Subdir: $SUBDIR"

            CLONE_DIR=$(mktemp -d)
            git clone --depth 1 --branch "$BRANCH" "$REPO_URL" "$CLONE_DIR"
            cp -r "$CLONE_DIR/$SUBDIR/." "$LOCAL_RUNPATH/"
            rm -rf "$CLONE_DIR"

            echo "Downloaded runpath contents to: $LOCAL_RUNPATH"
            ls "$LOCAL_RUNPATH"
          fi

          # Export for use in the next step
          echo "LOCAL_RUNPATH=$LOCAL_RUNPATH" >> $GITHUB_ENV

      - name: Run pipeline tests
        run: |
          echo "Running tests on local runner..."
          echo "Tests: ${{ inputs.run_tests }}"
          echo "Profile: ${{ inputs.nft_profile }}"
          echo "Nextflow version: ${{ inputs.nxf_version }}"
          echo "Max parallel: ${{ inputs.max_parallel }}"
          echo "Local runpath: $LOCAL_RUNPATH"

          # Convert comma-separated list to space-separated for nf-test
          TEST_FILES=$(echo "${{ inputs.run_tests }}" | tr ',' ' ')

          nf-test test \
            --profile "${{ inputs.nft_profile }}" \
            --params "runpath=$LOCAL_RUNPATH" \
            $TEST_FILES