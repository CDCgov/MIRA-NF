name: Run nf-test CI/CD

# Triggers
on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - dev
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      run_on_batch:
        description: "Run tests in batch mode"
        required: false
        default: false
        type: boolean
      only_changed:
        description: "Run tests only for changed modules"
        required: false
        default: false
        type: boolean
      max_parallel:
        description: "Maximum number of parallel test runs"
        required: false
        default: 2
        type: number

# Concurrency: only one workflow active per branch or PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Jobs
# Jobs
jobs:
  nf-test:
    strategy:
      matrix:
        NXF_VER: ["24.10.5"]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Nextflow
        run: |
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/
          nextflow -version

      - name: Set environment variables
        run: |
          echo "RUN_ON_BATCH=${{ github.event.inputs.run_on_batch || 'false' }}" >> $GITHUB_ENV
          echo "ONLY_CHANGED=${{ github.event.inputs.only_changed || 'false' }}" >> $GITHUB_ENV
          echo "MAX_PARALLEL=${{ github.event.inputs.max_parallel || '2' }}" >> $GITHUB_ENV
          echo "NXF_VERSION=${{ matrix.NXF_VER }}" >> $GITHUB_ENV
          echo "NFT_PROFILE=$( [[ '${{ github.event.inputs.run_on_batch }}' == 'true' ]] && echo 'dev' || echo 'docker' )" >> $GITHUB_ENV

      - name: Run nf-test pipeline
        run: |
          # Define a unique output directory per run
          TEST_OUTDIR=results/test_run_${GITHUB_RUN_NUMBER}
          mkdir -p $TEST_OUTDIR
          echo "Output directory: $TEST_OUTDIR"

          echo "Running nf-test with:"
          echo "  NXF_VERSION=$NXF_VERSION"
          echo "  RUN_ON_BATCH=$RUN_ON_BATCH"
          echo "  ONLY_CHANGED=$ONLY_CHANGED"
          echo "  NFT_PROFILE=$NFT_PROFILE"
          echo "  MAX_PARALLEL=$MAX_PARALLEL"
          echo "  OUTPUT_DIR=$TEST_OUTDIR"

          # Run Nextflow test pipeline with the output directory
          nextflow run main.nf \
            -profile $NFT_PROFILE \
            --outdir $TEST_OUTDIR \
            -with-trace tests/default.nf.test