name: NF Test Reusable Workflow

on:
  workflow_call:
    inputs:
      run_on_aws:
        description: "Run pipeline on AWS"
        required: false
        type: boolean
        default: false
      component_type:
        description: "Component type"
        required: true
        type: string
      run_tests:
        description: "Comma separated test files"
        required: false
        type: string
        default: "tests/default.nf.test"
      nft_profile:
        description: "Nextflow profile"
        required: false
        type: string
        default: "docker"
      nxf_version:
        description: "Nextflow version"
        required: false
        type: string
        default: "24.10.5"
      max_parallel:
        description: "Maximum parallel runs"
        required: false
        type: number
        default: 2

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Nextflow
        run: |
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/
          nextflow -version

      - name: Run pipeline tests
        run: |
          echo "Running tests on local runner..."
          echo "Tests: ${{ inputs.run_tests }}"
          echo "Profile: ${{ inputs.nft_profile }}"
          echo "Nextflow version: ${{ inputs.nxf_version }}"
          echo "Max parallel: ${{ inputs.max_parallel }}"

          # Loop over comma-separated test files
          for test_file in $(echo "${{ inputs.run_tests }}" | tr ',' ' '); do
            echo "Running test: $test_file"
            nextflow run main.nf \
              -profile ${{ inputs.nft_profile }} \
              -with-trace $test_file
          done