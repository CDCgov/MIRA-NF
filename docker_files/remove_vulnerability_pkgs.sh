#!/bin/bash
# Wrapper to remove vulnerability packages

PROJECT_DIR=${PROJECT_DIR:-/mira-nf}
python_version=${python_version:-python3.10}
remove_pkgs=${PROJECT_DIR}/remove_vulnerability_pkgs.txt
remove_pkgs_clean=${PROJECT_DIR}/remove_vulnerability_pkgs_clean.txt

echo $remove_pkgs

if [[ -f ${remove_pkgs} ]]; then

    echo "Remove vulnerability packages"

    # Remove blank lines from the file and save a cleaner version of it
    awk NF <${remove_pkgs} >${remove_pkgs_clean}

    # Get number of packages in the file
    n=$(wc -l <${remove_pkgs_clean})
    i=1
    #!/bin/bash
    # Wrapper to remove vulnerable Python packages

    PROJECT_DIR=${PROJECT_DIR:-/mira-nf}
    PYTHON_VERSION=${python_version:-python3.10}
    REMOVE_PKGS="${PROJECT_DIR}/remove_vulnerability_pkgs.txt"
    REMOVE_PKGS_CLEAN="${PROJECT_DIR}/remove_vulnerability_pkgs_clean.txt"

    echo "Remove packages file: $REMOVE_PKGS"

    # Remove packages if the file exists
    if [[ -f "$REMOVE_PKGS" ]]; then
        echo "Removing vulnerability packages..."

        # Remove blank lines from the file
        awk NF <"$REMOVE_PKGS" >"$REMOVE_PKGS_CLEAN"

        # Get number of packages
        n=$(wc -l <"$REMOVE_PKGS_CLEAN")
        i=1

        while [[ $i -le $n ]]; do
            echo "Processing package #$i"

            # Get the package name
            pkg_name=$(sed -n "${i}p" "$REMOVE_PKGS_CLEAN" | tr -d '\r')
            echo "Removing package: $pkg_name"

            # Remove package directories if they exist
            find "/usr/local/lib/${PYTHON_VERSION}/site-packages" -name "*${pkg_name}*" -exec rm -rf {} \;

            ((i++))
        done

        echo "All vulnerable packages removed."
    fi

    while [[ i -le $n ]]; do
        echo $i
        # Get the name of the package
        pkg_name=$(head -${i} ${remove_pkgs_clean} | tail -1 | sed 's,\r,,g')
        echo $pkg_name
        # Remove the package if it exists
        find /usr/local/lib/${python_version}/site-packages -name "*${pkg_name}*" -exec rm -rf {} \;
        # Go to next file
        i=$(($i + 1))
    done

    # Return message to keep the process going
    echo "Done"

fi
