# cdcgov/mira-nf: Output

## Introduction

This document describes the output produced by the pipeline. Most of the plots are taken from the MultiQC report, which summarizes results at the end of the pipeline.

The directories listed below will be created in the results directory after the pipeline has finished. All paths are relative to the top-level results directory.

## Pipeline overview

The pipeline is built using [Nextflow](https://www.nextflow.io/) and processes data using the following steps:

- [Pipeline information](#pipeline-information) - Report metrics generated during the workflow execution
- [Reads Prepped for IRMA](#reads-prepped-for-irma) - The subsampled and trimmed fastq inputs that IRMA will use for assembly
- [IRMA](#irma-outputs) - A folder containing all of the outs made by IRMA
- [DAIS-ribosome](dais-ribosome-outputs) - Aggregate insertion, deletion and sequence file for the input data
- [PrepareMIRAReports](#preparemirareports) - Collected results from IRMA and DAIS-Ribosome to create MIRA reoprts (JSON, HTML, FASTA, CSV and optional PARQ files)
- [Nextclade](#nextclade) - Input fasta file for Nextclade and Nextclade outputs if Nextclade was run within the workflow.


## Output Structure

```bash
|---outputs/
    |---aggregate_outputs/
        |---multiqc/  (when applicable) --> multiqc outputs
        |---dais-ribosome/ -> dais inputs and outputs
        |---dash-json/ -> json files
        |---mira-reports/ -> the aggregated fasta files and html files
        |---csv-reports/ -> CSV summary files
        |---parquet-reports/ (when applicable)
    |---Sample_ID/
        |---subsampled-reads/ (when applicable) -> fastqs and log files
        |---barcode-trimmed-reads/ (when applicable) -> fastqs and log files
        |---primer-trimmed-reads/ (when applicable) -> fastqs and log files
        |---IRMA/Sample_ID/ -> IRMA outputs and log files
        |---IRMA-negative/ (when applicable)
    |---nextclade -> Inputs and outputs for Nextclade
        |---input_fasta_files/ -> Input FASTA files for running Nextclade
        |--- All nextclade outputs files including aligned fastas, auspice json, and csv files.
    |---fastq_pass/ -> ONT data only – concatenated fastqs
    |---pipeline_info/ -> execution reports, sad_samples.tsv and program versions file
```

### MultiQC

<details markdown="1">
<summary>Output files</summary>

- `aggregate_outputs/multiqc/`
  - `multiqc_report.html`: a standalone HTML file that can be viewed in your web browser.
  - `multiqc_data/`: directory containing parsed statistics from the different tools used in the pipeline.
  - `multiqc_plots/`: directory containing static images from the report in various formats.

</details>

![MultiQC - FastQC sequence counts plot](images/mqc_fastqc_counts.png)

![MultiQC - FastQC mean quality scores plot](images/mqc_fastqc_quality.png)

![MultiQC - FastQC adapter content plot](images/mqc_fastqc_adapter.png)

:::note
The FastQC plots displayed in the MultiQC report shows _untrimmed_ reads. They may contain adapter sequence and potentially regions with low quality.
:::

[MultiQC](http://multiqc.info) is a visualization tool that generates a single HTML report summarizing all samples in your project. Most of the pipeline QC results are visualised in the report and further statistics are available in the report data directory.

Results generated by MultiQC collate pipeline QC from supported tools e.g. FastQC. The pipeline has special steps which also allow the software versions to be reported in the MultiQC output for future traceability. For more information about how to use MultiQC reports, see <http://multiqc.info>.

### Pipeline information

<details markdown="1">
<summary>Output files</summary>

- `pipeline_info/`
  - Reports generated by Nextflow: `execution_report.html`, `execution_timeline.html`, `execution_trace.txt` and `pipeline_dag.dot`/`pipeline_dag.svg`.
  - Reformatted samplesheet files used as input to the pipeline: `samplesheet.valid.csv`.
  - Parameters used by the pipeline run: `params.json`.

</details>

### Reads Prepped for IRMA

<details markdown="1">
<summary>Output files</summary>

- `sample_id/subsampled-reads`
  - Subsampled read in fastq file
- `sample_id/barcode-trimmed-reads`
  - barcode trimmed reads in fastq files for those experiment types that require trimming
- `sample_id/primer-trimmed-reads`
  - primer trimmed reads in fastq files for those experiment types that require trimming

</details>

### IRMA

<details markdown="1">
<summary>Output folder with sample name</summary>

`sample_id/IRMA/sample_id`

IRMA output directory structure (only showing A_MP)

- `amended_consensus/`
  - Mixture_Example_7.fa - amended consensus
  - Mixture_Example_7.a2m - Optional amended global alignment to profile HMM
  - Mixture_Example_7.pad.fa - Optional N-padded consensus for amplicon dropouts.

- `figures/`
  - A_MP-coverageDiagram.pdf - Shows coverage and variant calls
  - A_MP-heuristics.pdf - Heuristic graphs for A_MP
  - A_MP-EXPENRD.pdf - A_MP variant phrasing using normalized joint probability distances
  - A_MP-JACCARD.pdf - A_MP variant phasing using modified Jaccard distances
  - A_MP-MUTUALD.pdf - A_MP variant phasing using mutual association distances
  - A_MP-NJOINTP.pdf - A_MP variant phasing using normalized joint probability distances
  - READ_PERCENTAGES.pdf - Break down or reads assembled

- `intermediate/`
  - `0-ITERATIVE-REFERENCES/`
  - R0-A_MP.ref - Starting reference library sequence for A_MP
  - R1-A_MP.ref - Working reference for A_MP after round 1, template for round 2
  - R2-A_MP.ref - Working reference for A_MP after round 2
  - `1-MATCH_BLAT/`
  - R1-tar.gz - Archive of BLT results for the MATCH step
  - R2-tar.gz - Archive of BLT results for the MATCH step
  - R3-tar.gz - Archive of BLT results for the MATCH step
  - `2-SORT_BLAT/`
  - R1.tar.gz - Classification/sorting intermediate files for round 1
  - R1.txt - Summary statistics of sorting results for round 1
  - R2.tar.gz - Classification/sorting intermediate files for round 2
  - R2.txt - Summary statistics of sorting results for round 2
  - `3-ALIGN_SAM/`
  - storedCounts.tar.gz - Static files used to create rough assembly consensus sequences
  - `4-ASSEMBLE_SSW/`
  - F1-A_MP.bam - Unsorted BAM file for A_MP assembly, iteration 1
  - F1-A_MP.ref - Reference for final assembly, A_MP, iteration 1
  - F2-A_MP.bam - Unsorted BAM file for A_MP assembly, iteration 2
  - F2-A_MP.ref - Reference for final assembly, A_MP, iteration 2
  - reads.tar.gz - Archive of sorted, unmerged reads by gene segment

- `logs/`
  - ASSEMBLY_log.txt SSW scores per all rounds tried in the iterative refinement
  - NR_COUNTS_log.txt - Read pattern counts at various stages
  - QC_log.txt - Quality control output
  - READ_log.txt - Counts of assembled reads from BAM files
  - FLU-Mixture_EXample.sh - Configuration files corresponding to this IRMAS run
  - run_info.txt - Table of parameters used by the IRMA run

- `matrices/`
  - A_MP-EXPENRD.sqm - log file for normalized joint probability phasing
  - A_MP-JACCARD.sqm - log file for jaccard phasing
  - A_MP-MUTUALD.sqm - log file for mutual association phasing
  - A_MP-NJOINTP.sqm - log file for normalized joint probability phasing

- `secondary/`
  - R1-A_NA_N1.fa - Trace A_NA_N1 sorted into secondary status
  - R1-UNRECOGNIZABLE.fa - Read patterns that matched flu but had poor signal according to LABEL
  - R2-UNRECOGNIZABLE.fa - Read patterns that matched flu but had poor signal according to LABEL
  - unmatched_read_patterns.tar.gz - Archive of left over read patterns that did not match FLU

  - `tables/`
    - A_MP-pairingStats.txt - Summary of paired-end merging statistics, if applicable, A_MP
    - A_MP-coverage/txt - Summary coverage statistics for the assembly, A_MP
    - A_MP-coverage.a2m.txt - Optional coverage statistics for plurality consensus globally aligned to profile HMM
    - A_MP-coverage.pad.txt - Optional coverage statistics for padded plurality consensus globally aligned to profile HMM
    - A_MP-allAlleles.txt - Statistics for every position & allele in the assembly, A_MP
    - A_MP-insertions.txt - Called insertion variants for A_MP
    - A_MP-deletions.txt -Called deletion variant for A_MP
    - A_MP-variants.txt - Called single nucleotide variants for A_MP
    - READ_COUNTS.txt - Read counts for various points in the assembly process

- A_MP.bam - Sorted BAM file for the final A_MP assembly (merged if applicable)
- A_MP.bam.bai - BAM file index for A_MP assembly
- A_MP.fasta - Final assembled plurality consensus (no mixed base calls) for A_MP
- A_MP.a2m - Optional plurality consensus aligned to profile HMM
- A_MP.VCF - Custom variant call file for called IRMA variants, A_MP

  - `residual_assembly/` - Optional residual assembly results
  - `secondary_assembly/` - Optional secondary assembly results

</details>

The output for IRMA is written into the working directory as a new subfolder. This subfolder is named using the sample name. Above are the typical outputs created by IRMA. These outputs include an amended consensus, variant information and coverage information.

![Alt text](images/irma_coverage_image.png)
Coverage figure created by IRMA

### DAIS-ribosome

<details markdown="1">
<summary>Output files</summary>

- `aggregate_outputs/dais-ribosome/`
  - DAIS_ribosome_input.fasta - input fasta files that is used as the input for DAIS-ribosome
  - DAIS_ribosome.in - file contains the insertion found in all the samples assembled by IRMA
  - DAIS_ribosome.del - file contains the deletions found in all the samples assembled by IRMA
  - DAIS_ribosome.seq - file contains sequence related data from all the samples assembled by IRMA

</details>

Aggregate insertion, deletion and sequence file for the input data

An insertion file output example:

| ID | C_type | Ref_ID | Protein | Upstream_aa | Inserted_nucleotides | Inserted_residues | Upstream_nt | Codon_shift |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| 11209 | B_HA | PHUKET3073 | HA | 161 | aaa | K | 483 | 0 |
| 154957 | B_HA | PHUKET3073 | HA | 163 | krc | X | 489 | 0 |
| 223550 | B_HA | PHUKET3073 | HA | 161 | caa | Q | 483 | 0 |

A deletion file example:

| ID | C_type | Ref_ID | Protein | VH | Del_AA_start | Del_AA_end | Del_AA_len | In_frame | CDS_ID | Del_CDS_start | Del_CDS_end | Del_CDS_len |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
|EPI_ISL_410721|SARS-CoV-2|WUHAN19|orf1ab|5ba70e95c9a3251bc6155f62295dd3e8|994|1002|9|true|29cd767e2d144c31179395fd606d1489ce731746|2980|3006|27|
|EPI_ISL_410721|SARS-CoV-2|WUHAN19|orf1ab|5ba70e95c9a3251bc6155f62295dd3e8|1012|1012|1|true|29cd767e2d144c31179395fd606d1489ce731746|3034|3036|3|
|EPI_ISL_410721|SARS-CoV-2|WUHAN19|S|450c068c437e7536d27fdb883d95d4f4|72|72|1|true|36a75a0d34960c048abaf82ee46a1b713eee534e|214|216|3|
|EPI_ISL_410721|SARS-CoV-2|WUHAN19|S|450c068c437e7536d27fdb883d95d4f4|146|146|1|true|36a75a0d34960c048abaf82ee46a1b713eee534e|436|438|3|
|EPI_ISL_410721|SARS-CoV-2|WUHAN19|S|450c068c437e7536d27fdb883d95d4f4|254|256|3|true|36a75a0d34960c048abaf82ee46a1b713eee534e|760|768|9|
|EPI_ISL_410721|SARS-CoV-2|WUHAN19|S|450c068c437e7536d27fdb883d95d4f4|680|683|4|true|36a75a0d34960c048abaf82ee46a1b713eee534e|2038|2049|12|

A sequence file output example:

| ID | C_type | Ref_ID | Protein | VH |  AA_seq | AA_aln | CDS_id | Insertion | Shift_Insert | CDS_seq | CDS_aln | Query_nt_coordinates | CDS_nt_coordinates |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| 223550 | B_HA | BRISBANE60 | HA-signal | e81d2d895c70e91bb3ef917fe49fdab7 | MKAIIVLLMVVTSNA | MKAIIVLLMVVTSNA | 2aa6443b92ca45b301faa4d46e5fbd3b010e3ab7 |  false | false |ATGAAGGCAATAATTGTACTACTCATGGTAGTAACATCCAATGCA | ATGAAGGCAATAATTGTACTACTCATGGTAGTAACATCCAATGCA | 20..64 | 1..45 |
| 223550 | B_HA | PHUKET3073 | HA-signal | e81d2d895c70e91bb3ef917fe49fdab7 | MKAIIVLLMVVTSNA | MKAIIVLLMVVTSNA | 2aa6443b92ca45b301faa4d46e5fbd3b010e3ab7 | false | false | ATGAAGGCAATAATTGTACTACTCATGGTAGTAACATCCAATGCA | ATGAAGGCAATAATTGTACTACTCATGGTAGTAACATCCAATGCA | 20..64 | 1..45 |
| 11209 | B_HA | BRISBANE60 | HA-signal | c7ee7ff234abf5c0591e0fe1af26ca87 | MKAIIILLMVVTSNA | MKAIIILLMVVTSNA | c49a73ab7280362c8c710abbf648708c41f97712 | false | false | ATGAAGGCAATAATTATACTACTCATGGTAGTAACATCCAATGCA | ATGAAGGCAATAATTATACTACTCATGGTAGTAACATCCAATGCA | 1..45 | 1..45 |
| 11209 | B_HA | PHUKET3073 | HA-signal | c7ee7ff234abf5c0591e0fe1af26ca87 | MKAIIILLMVVTSNA | MKAIIILLMVVTSNA | c49a73ab7280362c8c710abbf648708c41f97712 | false | false | ATGAAGGCAATAATTATACTACTCATGGTAGTAACATCCAATGCA | ATGAAGGCAATAATTATACTACTCATGGTAGTAACATCCAATGCA | 1..45 | 1..45 |

### PrepareMIRAReports

<details markdown="1">
<summary>Output files</summary>

The collected results from IRMA and DAIS-Ribosome in JSON files - These are for vizualizing in MIRA-GUI
- `aggregate_outputs/dash-json/`
  - barcode_distribution.json
  - coveragefig_sample_#_linear.json
  - coverage.json
  - dais_vars.json
  - heatmap.json
  - indels.json
  - irma_summary.json
  - minor_variants.json
  - nt_sequences.json
  - pass_fail_heatmap.json
  - pass_fail_qc.json
  - qc_statement.json
  - readsfig_sample_#.json
  - reads.json
  - ref_data.json
  - vtpye.json

 HTML files and combined amended consensus FASTA files are created in this step.
- `aggregate_outputs/mira-reports`
  - mira_<runid>_amended_consensus.fasta
  - mira_<runid>_failed_amended_consensus.fasta
  - mira_<runid>_amino_acid_consensus.fasta
  - mira_<runid>_failed_amino_acid_consensus.fasta
  - mira_sample_#_coverage.html
  - mira_<runid>_summary.html

 Explanations of the summary HTML for Illumina data can be found here: <https://cdcgov.github.io/MIRA/articles/running-mira-cli-illumina.html#mira-cli-ouputs>
 Explanations of the summary HTML for ONT data can be found here: <https://cdcgov.github.io/MIRA/articles/running-mira-cli-ont.html>

The collected results from IRMA and DAIS-Ribosome in CSV files
- `aggregate_outputs/csv-files/`
  - **mira_<runid>_aavars.csv**
    | Column Name | Definition |
    |-------------|------------|
    | sample_id | Unique sample identifier. |
    | reference_id | Reference genome used by DAIS-ribosome for annotation. |
    | protein | Protein name where variants were detected. |
    | aa_variant_count | Number of amino acid variants detected in the protein. |
    | aa_variants | List of amino acid variant annotations. |

  - **mira_<runid>_amended_consensus.csv**
    | Column Name | Definition |
    |-------------|------------|
    | sample_id | Unique sample identifier. |
    | reference | Reference genome or segment name. |
    | qc_decision | Final QC decision for the sequence. |
    | sequence | Amended nucleotide consensus sequence. |
    | runid | Sequencing run identifier. |
    | instrument | Sequencing instrument used. |

  - **mira_<runid>_amino_acid_consensus.csv**
    | Column Name | Definition |
    |-------------|------------|
    | sample_id | Unique sample identifier. |
    | reference | Protein name corresponding to the consensus sequence. |
    | qc_decision | QC decision for the protein consensus. |
    | sequence | Amino acid consensus sequence. |
    | runid | Sequencing run identifier. |
    | instrument | Sequencing instrument used. |

  - **mira_<runid>_coverage.csv**
    | Column Name | Definition |
    |-------------|------------|
    | sample_id | Unique identifier for the sample being analyzed. |
    | reference | Reference genome or segment name used for alignment. |
    | reference_position | Genomic position within the reference sequence. |
    | depth | Total coverage depth at position for all alleles (not counting deletions & ambiguous nucleotides). |
    | consensus | Consensus nucleotide call at this position. |
    | deletions | Deleted states, not included in coverage depth. |
    | ambiguous | Number of ambiguous ("N") states in the reads, not included in coverage depth. |
    | consensus_count |  Coverage depth of the consensus allele. |
    | consensus_average_quality | Average base quality score for the consensus allele. |
    | run_id | Unique identifier for the sequencing run. |
    | instrument | Sequencing instrument used for the run. |

  - **mira_<runid>_indels.csv**
    | Column Name | Definition |
    |-------------|------------|
    | sample | Unique sample identifier. |
    | sample_upstream_position | Reference position immediately upstream of the indel event. |
    | reference_name | Reference genome or segment name. |
    | context | 5 bp flanking regions around indel event |
    | length | Length of deletions. NULL if insertion. |
    | insert | Inserted sequence (if insertion). |
    | count | Number of reads supporting the indel. |
    | upstream_base_coverage | Total coverage at the upstream reference position. |
    | frequency | Frequency of the indel. |
    | runid | Sequencing run identifier. |
    | instrument | Sequencing instrument used. |

  - **mira_<runid>_irma_config.csv**
    | Column Name | Definition |
    |-------------|------------|
    | program_name | Name of process being used by program. |
    | program | Program name. |
    | irma | IRMA software identifier string. |
    | runid | Sequencing run identifier. |
    | instrument | Sequencing instrument used. |
    | timestamp | Timestamp of report generation. |

  - **mira_<runid>_reads.csv**
    | Column Name | Definition |
    |-------------|------------|
    | sample_id | Unique identifier for the sample. |
    | record | Processing record label for read counts. See below. |
    | reads | Number of reads in this record category. |
    | patterns |  Number of read patterns for the group. Patterns are de-duplicated read sequences.|
    | pairs_and_windows | The number of merged paired-end reads (if applicable). Widows have no paired-end mate. |
    | stage | Record stage at which reads were counted. |
    | run_id | Unique identifier for the sequencing run. |
    | instrument | Sequencing instrument used. |

    **Record - Group of records**
    - 0 -Original data files
    - 1 - Aggregated data
    - 2 - Data partitioned during quality control step
    - 3 - Data partitioned during the read gathering phase
    - 4 - Primary data used in the final assembly phase (3-match)
    - 5 - Additional secondary data not used in the final assembly phase (3-altmatch)

  - **mira_<runid>_summary.csv**
    | Column Name | Definition |
    |-------------|------------|
    | sample_id | Unique sample identifier. |
    | total_reads | Total number of reads generated for the sample. |
    | pass_qc | Reads that passed QC criteriafor the sample. |
    | reads_mapped | Number of reads mapped to the reference. |
    | reference | Reference genome or segment. |
    | percent_reference_coverage | Percentage of the reference genome/segment covered by reads. |
    | median_coverage | Median sequencing depth across the reference. |
    | count_minor_snv_at_or_over_5_pct | Number of minor SNVs with frequency ≥5%. |
    | spike_percent_coverage | (optional) Percent coverage across the spike gene. Present of SC2-Whole-Genome data. |
    | spike_median_coverage | (optional) Median depth across the spike gene. Present of SC2-Whole-Genome data. |
    | pass_fail_reason | Explanation for QC failure (if applicable). |
    | subtype | Assigned viral subtype or lineage to be used by nextclade. |
    | mira_module | MIRA version and config settings used for analysis. |
    | runid | Sequencing run identifier. |
    | instrument | Sequencing instrument used. |

    **Additional Fields if Nextclade has been run**
    | Column Name | Virus | Definition |
    |-------------|--------|------------|
    | clade | sc2-wgs | Nextclade clade designation. |
    | clade_who | sc2-wgs | WHO clade designation. |
    | nextclade_pango | sc2-wgs | Assigned Pango lineage from Nextclade. |
    | clade | flu | Assigned influenza clade designation. |
    | short_clade | flu | Abbreviated clade label. |
    | subclade | flu | Influenza subclade classification. |
    | clade | rsv | Assigned viral clade designation. |
    | g_clade | rsv | GISAID clade designation. |

  - **mira_<runid>_minor_variants.csv**
    | Column Name | Definition |
    |-------------|------------|
    | sample | Unique sample identifier. |
    | reference | Reference genome or segment name. |
    | sample_position |  Position of the called single nucleotide variant. |
    | reference_position | (optional) HMM-based reference position of the variant. Present with SC2-Spike-ONT data. |
    | depth | Total coverage depth at that position for all alleles not counting ambiguous nucleotides |
    | consensus_allele | Plurality consensus allele at that position. |
    | minority_allele | Minor allele detected at this position. |
    | consensus_count | Plurality consensus observation count at that position |
    | minority_count | Minor variant observation count at that position |
    | minority_frequency | Minor variant frequency at that position. |
    | run_id | Sequencing run identifier. |
    | instrument | Sequencing instrument used. |

Optional collected results from IRMA and DAIS-Ribosome in PARQ files
- `aggregate_outputs/parquet-reports/`
  - mira_<runid>_all_alleles.parq
  - mira_<runid>_amended_consensus.parq
  - mira_<runid>_amino_acid_consensus.parq
  - mira_<runid>_coverage.parq
  - mira_<runid>_indels.parq
  - mira_<runid>_irma_config.parq
  - mira_<runid>_minor_variants.parq
  - mira_<runid>_reads.parq
  - mira_<runid>_samplesheet.parq
  - mira_<runid>_summary.parq

</details>

### Nextclade
- `nextclade/input_fasta_files/` - potential input fasta files
```
nextclade_<runid>_influenza-a-h3n2-ha.fasta
nextclade_<runid>_influenza-a-h1n1pdm-ha.fasta
nextclade_<runid>_influenza-b-victoria-ha.fasta
nextclade_<runid>_influenza-a-h1n1pdm-na.fasta
nextclade_<runid>_influenza-a-h3n2-na.fasta
nextclade_<runid>_influenza-b-victoria-na.fasta
nextclade_<runid>_rsv-a.fasta
nextclade_<runid>_rsv-b.fasta
nextclade_<runid>_sars-cov-2.fasta
```
- `nextclade/` - potential output files
```
 - csv - CSV file containing nextclade results
 - error_csv - CSV file containing errors from nextclade results
 - insertions_csv - CSV file containing insertions from nextclade results
 - tsv - TSV file containing nextclade results
 - json - JSON file containing nextclade results
 - json_auspice - Auspice JSON V2 containing nextclade results
 - ndjson - newline-delimited JSON file containing nextclade results
 - fasta_aligned - FASTA file containing aligned sequences from nextclade results
 - fasta_translation - FASTA file containing aligned peptides from nextclade results
 - nwk - NWK file containing nextclade results
```

[Nextflow](https://www.nextflow.io/docs/latest/tracing.html) provides excellent functionality for generating various reports relevant to the running and execution of the pipeline. This will allow you to troubleshoot errors with the running of the pipeline, and also provide you with other information such as launch commands, run times and resource usage.
