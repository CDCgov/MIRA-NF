#!/bin/bash
# Wrapper to install Python packages

# Path to requirement file
PROJECT_DIR=${PROJECT_DIR:-/fastqc}
FIXED_PKGS="${PROJECT_DIR}/fixed_vulnerability_pkgs.txt"
FIXED_PKGS_CLEAN="${PROJECT_DIR}/fixed_vulnerability_pkgs_clean.txt"

echo "Fixed packages file: $FIXED_PKGS"

# Install updated version of Python packages if the file exists
if [[ -f "$FIXED_PKGS" ]]; then
    echo "Updating Python packages..."

    # Remove blank lines from the file
    awk NF <"$FIXED_PKGS" >"$FIXED_PKGS_CLEAN"

    # Get number of packages in the file
    n=$(wc -l <"$FIXED_PKGS_CLEAN")
    i=1

    while [[ $i -le $n ]]; do
        echo "Processing package #$i"

        # Get the package name and version
        updated_pkg=$(sed -n "${i}p" "$FIXED_PKGS_CLEAN" | tr -d '\r')
        echo "Package to update: $updated_pkg"

        pkg_name=$(echo "$updated_pkg" | sed -E 's/(.*)==(.*)/\1/')
        echo "Package name: $pkg_name"

        # Check if package is already installed
        check_pip_pkg=$(pip list --format=freeze | grep -w "$pkg_name")
        echo "Currently installed: ${check_pip_pkg:-none}"

        # Update package if it exists
        if [[ -n "$check_pip_pkg" ]]; then
            pip install --no-cache-dir "$updated_pkg"
        fi

        ((i++))
    done

    echo "All packages updated."
fi
